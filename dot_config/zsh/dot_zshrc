# { Reference: https://github.com/romkatv/powerlevel10k/blob/master/README.md#how-do-i-initialize-direnv-when-using-instant-prompt
  command_exists direnv && emulate zsh -c "$(direnv export zsh)"
# }

# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# { Zsh
  # set HISTFILE and HISTSIZE and SAVEHIST again because /etc/zshrc overwrites them.
  file_exists_then_source "${ZDOTDIR}/setup-history.zsh"
# }

# { Editor
  command_exists nvim && export EDITOR="nvim"
# }

# { Man
  command_exists col && command_exists bat && export MANPAGER='zsh -c "col -bx | bat -pl man"'
# }

# { Zsh
  # Zsh vi mode config
  # Must before oh-my-zsh.zsh
  file_exists_then_source "${ZDOTDIR}/zvm-config.zsh"

  # Oh my zsh
  file_exists_then_source "${ZDOTDIR}/oh-my-zsh.zsh"

  file_exists_then_source "${ZDOTDIR}/functions.zsh"
  file_exists_then_source "${ZDOTDIR}/aliases.zsh"
  file_exists_then_source "${ZDOTDIR}/tmutil-auto-exclude.zsh"
# }

# { Cli
  # Zoxide
  command_exists zoxide && eval "$(zoxide init zsh)"

  # Fzf
  zvm_after_init_commands+=("file_exists_then_source ${XDG_CONFIG_HOME}/fzf.zsh") # See: https://github.com/jeffreytse/zsh-vi-mode#execute-extra-commands

  # Atuin
  command_exists atuin && eval "$(atuin init zsh --disable-up-arrow --disable-ctrl-r)"
  zvm_after_init_commands+=("file_exists_then_source ${XDG_CONFIG_HOME}/fzf-atuin.zsh")

  # Fzf-tab
  zvm_after_init_commands+=("file_exists_then_source ${XDG_CONFIG_HOME}/fzf-tab.zsh")
# }

# { Pgp
  export GPG_TTY="${TTY}"
# }

# { Fnm
  command_exists fnm && eval "$(fnm env --shell zsh)"
# }

# { Pyenv
  command_exists pyenv && eval "$(pyenv init -)"
# }

# { Goenv
  command_exists goenv && eval "$(goenv init -)"
# }

# { Jenv
  command_exists jenv && eval "$(jenv init -)"
# }

# { Direnv
  command_exists direnv && emulate zsh -c "$(direnv hook zsh)"
# }

# Ensure that $USER_LOCAL_BIN has the highest priority in $PATH
path=("${USER_LOCAL_BIN}" $path)

# To customize prompt, run `p10k configure` or edit $ZDOTDIR/p10k.zsh.
file_exists_then_source "${ZDOTDIR}/p10k.zsh"
file_exists_then_source "${ZDOTDIR}/p10k-fnm.zsh"

# Disable powerlevel10k when running under Cursor Agent
# This fixes compatibility issues where the agent cannot detect command completion
# due to the complex prompt structure of powerlevel10k
# Reference: https://forum.cursor.com/t/cursor-agent-terminal-doesn-t-work-well-with-powerlevel10k-oh-my-zsh/96808/14
if [[ -n $CURSOR_TRACE_ID ]]; then
  prompt_powerlevel9k_teardown
fi
