#!/usr/bin/env python3
import os
import subprocess

Brewfile = os.environ['HOMEBREW_BREWFILE']

mas_id_list = [
    '1176895641',  # Spark
    '1443749478',  # WPS Office
    '497799835',  # Xcode
    '1630034110',  # Bob
    '1352778147',  # Bitwarden
]


def main():
    env = os.environ
    env['HOMEBREW_NO_AUTO_UPDATE'] = 'true'
    cmd = subprocess.Popen(
        ['brew', 'bundle', 'dump', '--describe', '--file=-'],
        stdout=subprocess.PIPE,
        env=env,
    )

    stdout, _ = cmd.communicate()

    output = stdout.decode()
    output = '\n'.join([
        line for line in output.splitlines() if
        not (line.startswith('mas'))
        or (line.startswith('mas') and any([line.endswith(mas_id) for mas_id in mas_id_list]))
    ])

    os.makedirs(os.path.dirname(Brewfile), exist_ok=True)
    with open(Brewfile, 'w') as fp:
        fp.write(output)


if __name__ == '__main__':
    main()
