#!/usr/bin/env python3
import argparse
import pathlib
import subprocess

# Ref: https://apple.stackexchange.com/questions/339201/how-do-i-copy-multiple-files-to-macoss-clipboard-programmatically/339436#339436
script = '''
use framework "AppKit"

property this : a reference to current application
property NSFileManager : a reference to NSFileManager of this
property NSMutableArray : a reference to NSMutableArray of this
property NSPasteboard : a reference to NSPasteboard of this
property NSString : a reference to NSString of this

on run input
    set filePaths to NSMutableArray's array()
    set FileManager to NSFileManager's defaultManager()

    repeat with f in input
        set fp to (NSString's stringWithString:(f as text))'s ¬
            stringByStandardizingPath()
        if (FileManager's fileExistsAtPath:fp) then ¬
            (filePaths's addObject:fp)
    end repeat

    set pb to NSPasteboard's generalPasteboard()
    pb's clearContents()
    pb's setPropertyList:filePaths forType:"NSFilenamesPboardType"

    return true
end run
'''


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument(
        'paths',
        nargs='+',
        help='paths to files to add to clipboard',
        type=pathlib.Path,
        metavar='PATH'
    )
    args = parser.parse_args()
    paths = [str(p.resolve()) for p in args.paths]
    # Ref: https://stackoverflow.com/questions/2940916/how-do-i-embed-an-applescript-in-a-python-script/2941735#2941735
    p = subprocess.Popen(
        ['osascript', '-'] + paths,
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        universal_newlines=True
    )
    stdout, stderr = p.communicate(script)
    if p.returncode != 0 or not stdout.strip().startswith('true'):
        if stderr:
            print(stderr)
        exit(1)


if __name__ == '__main__':
    main()
