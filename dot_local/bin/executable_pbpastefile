#!/usr/bin/env python3
import argparse
import pathlib
import subprocess

script = '''
use framework "AppKit"

property this : a reference to current application
property NSFileManager : a reference to NSFileManager of this
property NSPasteboard : a reference to NSPasteboard of this
property NSString : a reference to NSString of this

on run argv
    if (count of argv) < 1 then
        error "Usage: paste_to_directory <destination_directory> [overwrite]"
    end if

    set destinationDirectory to (item 1 of argv) as text
    set overwrite to false
    if (count of argv) is 2 then
        set overwrite to (item 2 of argv) as text is "true"
    end if

    set pb to NSPasteboard's generalPasteboard()
    set filePaths to pb's propertyListForType:"NSFilenamesPboardType"
    if filePaths is missing value then
        error "No files in clipboard"
    end if

    set dp to (NSString's stringWithString:destinationDirectory)'s Â¬
        stringByStandardizingPath()
    set dPath to dp as text

    set fileManager to NSFileManager's defaultManager()
    repeat with sourcePath in filePaths
        set fileName to (NSString's stringWithString:(sourcePath as text))'s lastPathComponent() as text
        set destinationPath to dPath & "/" & fileName
        if overwrite then
            if (fileManager's fileExistsAtPath:destinationPath) then
                fileManager's removeItemAtPath:destinationPath |error|:(missing value)
            end if
        end if
        fileManager's copyItemAtPath:sourcePath toPath:destinationPath |error|:(missing value)
    end repeat

    return true
end run
'''

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument(
        'dest',
        help='The directory where the files will be pasted to',
        type=pathlib.Path,
        metavar='PATH'
    )
    parser.add_argument(
        '--overwrite',
        help='Overwrite existing files',
        action='store_true'
    )
    args = parser.parse_args()
    dest = str(args.dest.resolve())
    overwrite = 'true' if args.overwrite else 'false'
    p = subprocess.Popen(
        ['osascript', '-', dest, overwrite],
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        universal_newlines=True
    )
    stdout, stderr = p.communicate(script)
    if p.returncode != 0 or not stdout.strip().startswith('true'):
        if stderr:
            print(stderr)
        exit(1)

if __name__ == '__main__':
    main()
