#!/usr/bin/env python3
import os
import subprocess

shortcuts = [
    'chezmoi apply -Rvn --force | LESS="Rmc" delta --features "default paging"',
    'chezmoi apply -vn --force | LESS="Rmc" delta --features "default paging"',
    'chezmoi apply -v',
    'EXECUTE_CHEZMOIEXTERNAL=true chezmoi execute-template < .chezmoiexternal.yaml | bat -l yaml',
    'chezmoi state delete-bucket --bucket=scriptState',
]


def bat(cmd):
    bat_cmd = subprocess.Popen(
        ['bat', '--language=zsh', '--plain', '--color=always'],
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE
    )
    stdout, _ = bat_cmd.communicate(cmd.encode())
    return stdout.decode()


def get_chezmoi_source_path():
    chezmoi_cmd = subprocess.Popen(
        ['chezmoi', 'source-path'],
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE
    )
    stdout, _ = chezmoi_cmd.communicate()
    return stdout.decode().strip()


def main():
    os.chdir(get_chezmoi_source_path())

    coloured_shortcuts = [bat(c) for c in shortcuts]

    fzf_cmd = subprocess.Popen(
        ['fzf', '--ansi'],
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE
    )
    fzf_cmd_stdout, _ = fzf_cmd.communicate('\n'.join(coloured_shortcuts).encode())
    if fzf_cmd.returncode != 0:
        exit(fzf_cmd.returncode)

    selected = fzf_cmd_stdout.decode().strip()

    os.execvp('zsh', ['zsh', '-ci', selected])


if __name__ == '__main__':
    main()
