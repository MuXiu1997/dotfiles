#!/usr/bin/env -S deno run -A --quiet --ext ts

import { $, fs, path } from 'npm:zx@8.8.1'

// è®¾ç½® Homebrew ç¯å¢ƒå˜é‡ä»¥ä¼˜åŒ–ä½“éªŒ
$.env = {
  ...$.env,
  // ç¦ç”¨è‡ªåŠ¨æ›´æ–°ä»¥åŠ å¿«å®‰è£…é€Ÿåº¦
  HOMEBREW_NO_AUTO_UPDATE: '1',
  // éšè—ç¯å¢ƒå˜é‡æç¤º
  HOMEBREW_NO_ENV_HINTS: '1',
  // ç¦ç”¨å®‰è£…æ—¶çš„æ¸…ç†æ“ä½œä»¥åŠ å¿«é€Ÿåº¦
  HOMEBREW_NO_INSTALL_CLEANUP: '1',
}

// ç¼“å­˜å˜é‡
let cachedCasks: string[] | null = null
let cachedFormulas: string[] | null = null
let cachedMasApps: Array<{ id: string; name: string; version: string }> | null =
  null

// æ¸…é™¤ç¼“å­˜å‡½æ•°
function clearCache() {
  cachedCasks = null
  cachedFormulas = null
  cachedMasApps = null
}

// è§£æåŒ…ç±»å‹å’Œåç§°
interface Package {
  type: 'cask' | 'formula' | 'mas'
  name: string
  id?: string // ä»…ç”¨äº mas åº”ç”¨
}

function parsePackage(arg: string): Package | null {
  const parts = arg.split(':')

  if (parts.length < 2) {
    console.error(`âŒ æ— æ•ˆçš„å‚æ•°æ ¼å¼: ${arg}`)
    return null
  }

  const type = parts[0] as 'cask' | 'formula' | 'mas'

  if (!['cask', 'formula', 'mas'].includes(type)) {
    console.error(`âŒ ä¸æ”¯æŒçš„åŒ…ç±»å‹: ${type}`)
    return null
  }

  if (type === 'mas') {
    if (parts.length < 3) {
      console.error(`âŒ mas åº”ç”¨éœ€è¦æä¾› ID å’Œåç§°: mas:id:name`)
      return null
    }
    return { type, id: parts[1], name: parts[2] }
  }

  return { type, name: parts[1] }
}

// è·å–å·²å®‰è£…çš„ cask åˆ—è¡¨
async function getInstalledCasks(): Promise<string[]> {
  if (cachedCasks !== null) {
    return cachedCasks
  }

  try {
    const result = await $`brew list --cask`.quiet()
    cachedCasks = result.stdout.trim().split('\n').filter((line) =>
      line.length > 0
    )
    return cachedCasks
  } catch (error) {
    cachedCasks = []
    return cachedCasks
  }
}

// è·å–å·²å®‰è£…çš„ formula åˆ—è¡¨
async function getInstalledFormulas(): Promise<string[]> {
  if (cachedFormulas !== null) {
    return cachedFormulas
  }

  try {
    const result = await $`brew list --formula`.quiet()
    cachedFormulas = result.stdout.trim().split('\n').filter((line) =>
      line.length > 0
    )
    return cachedFormulas
  } catch (error) {
    cachedFormulas = []
    return cachedFormulas
  }
}

// è·å–å·²å®‰è£…çš„ mas åº”ç”¨åˆ—è¡¨
async function getInstalledMasApps(): Promise<
  Array<{ id: string; name: string; version: string }>
> {
  if (cachedMasApps !== null) {
    return cachedMasApps
  }

  try {
    const result = await $`mas list`.quiet()
    cachedMasApps = result.stdout.trim().split('\n')
      .filter((line) => line.length > 0)
      .map((line) => {
        // åŒ¹é…æ ¼å¼: ID  AppName  (version)
        const match = line.match(/^(\d+)\s+(.+?)\s+\(([^)]+)\)$/)
        return match
          ? { id: match[1], name: match[2].trim(), version: match[3] }
          : null
      })
      .filter(Boolean) as Array<{ id: string; name: string; version: string }>
    return cachedMasApps
  } catch (error) {
    cachedMasApps = []
    return cachedMasApps
  }
}

// æ£€æŸ¥åŒ…æ˜¯å¦å·²å®‰è£…
async function isPackageInstalled(pkg: Package): Promise<boolean> {
  switch (pkg.type) {
    case 'cask':
      const installedCasks = await getInstalledCasks()
      return installedCasks.includes(pkg.name)

    case 'formula':
      const installedFormulas = await getInstalledFormulas()
      return installedFormulas.includes(pkg.name)

    case 'mas':
      const installedMasApps = await getInstalledMasApps()
      return installedMasApps.some((app) => app.id === pkg.id)

    default:
      return false
  }
}

// å®‰è£…åŒ…
async function installPackage(pkg: Package): Promise<boolean> {
  try {
    console.log(`ğŸ“¦ æ­£åœ¨å®‰è£… ${pkg.type}: ${pkg.name}...`)

    switch (pkg.type) {
      case 'cask':
        await $`brew install --cask --no-quarantine ${pkg.name}`
        break

      case 'formula':
        await $`brew install --formula ${pkg.name}`
        break

      case 'mas':
        await $`mas install ${pkg.id}`
        break
    }

    console.log(`âœ… æˆåŠŸå®‰è£… ${pkg.type}: ${pkg.name}`)

    // æ¸…é™¤ç›¸å…³ç¼“å­˜ï¼Œä»¥ä¾¿åç»­æ£€æŸ¥èƒ½è·å–æœ€æ–°çŠ¶æ€
    switch (pkg.type) {
      case 'cask':
        cachedCasks = null
        break
      case 'formula':
        cachedFormulas = null
        break
      case 'mas':
        cachedMasApps = null
        break
    }

    return true
  } catch (error) {
    console.error(`âŒ å®‰è£…å¤±è´¥ ${pkg.type}: ${pkg.name}`, error)
    return false
  }
}

// ä¸»å‡½æ•°
async function main() {
  const args = Deno.args

  if (args.length === 0) {
    console.log('ğŸ“‹ æ˜¾ç¤ºå·²å®‰è£…çš„åŒ…åˆ—è¡¨...\n')

    // æ˜¾ç¤ºå·²å®‰è£…çš„ cask åº”ç”¨
    const installedCasks = await getInstalledCasks()
    if (installedCasks.length > 0) {
      console.log('ğŸº å·²å®‰è£…çš„ cask åº”ç”¨:')
      installedCasks.forEach((cask, index) => {
        console.log(`  ${index + 1}. ${cask}`)
      })
      console.log()
    }

    // æ˜¾ç¤ºå·²å®‰è£…çš„ formula åŒ…
    const installedFormulas = await getInstalledFormulas()
    if (installedFormulas.length > 0) {
      console.log('âš—ï¸  å·²å®‰è£…çš„ formula åŒ…:')
      installedFormulas.forEach((formula, index) => {
        console.log(`  ${index + 1}. ${formula}`)
      })
      console.log()
    }

    // æ˜¾ç¤ºå·²å®‰è£…çš„ mas åº”ç”¨
    const installedMasApps = await getInstalledMasApps()
    if (installedMasApps.length > 0) {
      console.log('ğŸª å·²å®‰è£…çš„ Mac App Store åº”ç”¨:')
      installedMasApps.forEach((app, index) => {
        console.log(
          `  ${index + 1}. ${app.name} (ID: ${app.id}, ç‰ˆæœ¬: ${app.version})`,
        )
      })
      console.log()
    }

    console.log('ğŸ’¡ ä½¿ç”¨æ–¹æ³•:')
    console.log(
      '  install-packages cask:mounty formula:zsh mas:1630034110:Bob',
    )
    return
  }

  // è§£æå‚æ•°
  const packages: Package[] = []
  for (const arg of args) {
    const pkg = parsePackage(arg)
    if (pkg) {
      packages.push(pkg)
    }
  }

  if (packages.length === 0) {
    console.error('âŒ æ²¡æœ‰æœ‰æ•ˆçš„åŒ…å‚æ•°')
    return
  }

  console.log(`ğŸ” æ£€æŸ¥ ${packages.length} ä¸ªåŒ…çš„å®‰è£…çŠ¶æ€...\n`)

  // æ£€æŸ¥å¹¶å®‰è£…åŒ…
  for (const pkg of packages) {
    const isInstalled = await isPackageInstalled(pkg)

    if (isInstalled) {
      console.log(`âœ… ${pkg.type}: ${pkg.name} å·²ç»å®‰è£…`)
    } else {
      await installPackage(pkg)
    }
  }

  console.log('\nğŸ‰ å®‰è£…ä»»åŠ¡å®Œæˆï¼')
}

// è¿è¡Œä¸»å‡½æ•°
if (import.meta.main) {
  await main()
}
