#!/usr/bin/env python3
import os.path
import re
import sys
import time

function_regex = re.compile('function ([a-z_]+)\(\)\s[{]\n((?:.*?\n)+?)[}]')
set_CUTBUFFER_regex = re.compile('.*CUTBUFFER.*=')


def patch(function_name, function_body):
    before_function = ''
    after_function = ''
    if set_CUTBUFFER_regex.search(function_body) is None:
        before_function = '  CUTBUFFER="$(pbpaste)"\n'
    else:
        after_function = '\n  printf %s "${CUTBUFFER}" | pbcopy'
    print(
        '\n'.join([
            f'{function_name}() {{',
            f'{before_function}{function_body.rstrip()}{after_function}',
            f'}}',
            f'',
        ])
    )


def read_zsh_vi(path):
    with open(os.path.abspath(os.path.expanduser(path)), mode='r') as fp:
        content = fp.read()
        return content


def main():
    print(
        '\n'.join([
            f'#Generated by zsh-vi-mode-patch at {time.strftime("%Y-%m-%d %H:%M:%S", time.localtime())}',
            f'',
        ])
    )
    content = read_zsh_vi(sys.argv[1])
    for f in function_regex.finditer(content):
        function_name = f.groups()[0]
        function_body = f.groups()[1]
        if 'CUTBUFFER' in function_body:
            patch(function_name, function_body)


if __name__ == '__main__':
    main()
