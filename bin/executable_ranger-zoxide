#!/usr/bin/env python
import argparse
import os
import subprocess
import tempfile


def y_or_n(msg):
    import sys, tty, termios
    while True:
        print(msg)

        fd = sys.stdin.fileno()
        old_settings = termios.tcgetattr(fd)
        try:
            tty.setraw(sys.stdin.fileno())
            ch = sys.stdin.read(1)
        finally:
            termios.tcsetattr(fd, termios.TCSADRAIN, old_settings)
        if ch == 'n':
            return False
        if ch == 'y':
            return True


parser = argparse.ArgumentParser(description='ranger + zoxide.')
parser.add_argument(
    '--choosedir',
    help='makes ranger act like a file chooser. When opening a file, it will quit and write the name of the selected file to OUTFILE.',
)
parser.add_argument('-i', '--interactive', action='store_true', help='use interactive selection')
parser.add_argument('keywords', metavar='KEYWORDS', nargs='*')
args = parser.parse_args()

ranger_start_dir = os.getcwd()

zoxide_query_args = []
if args.interactive:
    zoxide_query_args.append('-i')
if len(args.keywords) != 0:
    zoxide_query_args.extend(args.keywords)

if len(zoxide_query_args) != 0:
    zoxide_query = subprocess.Popen(
        ['zoxide', 'query', *zoxide_query_args],
        stdout=subprocess.PIPE,
        stderr=None if args.interactive else subprocess.DEVNULL,
    )
    zoxide_query_stdout, _ = zoxide_query.communicate()

    if zoxide_query.returncode == 130:
        exit(130)
    if zoxide_query.returncode == 1:
        if not y_or_n('\033[0;33mno match found, use $PWD or not?\033[0m \033[0;29m[y/n]\033[0m'):
            exit(0)
    if zoxide_query.returncode == 0:
        ranger_start_dir = zoxide_query_stdout.decode().strip()

ranger_args = []
if args.choosedir is not None:
    ranger_args.extend(['--choosedir', args.choosedir])
ranger_args.append(ranger_start_dir)

os.execvp('ranger', ['ranger', *ranger_args])
