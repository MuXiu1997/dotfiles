#!/usr/bin/env bash

set -euo pipefail

# {{ template "shellLib" . }}

install_homebrew() {
  if ! type brew &>/dev/null; then
    local install_script_url='https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh'
    local install_script
    install_script="$(curl -fsSL "${install_script_url}")"
    if bash -c "${install_script}"; then
      log_success "Homebrew installation completed"
    else
      log_error "Failed to install Homebrew"
      return 1
    fi
  else
    log_info "Homebrew is already installed"
  fi
}

install_required_packages() {
  local packages=("git" "age" "chezmoi" "uv" "deno")
  local brew_exec='{{ .homebrewExec }}'

  for package in "${packages[@]}"; do
    if ! "${brew_exec}" list --versions "${package}" &>/dev/null; then
      log_progress "Installing ${package}..."
      if "${brew_exec}" install "${package}"; then
        log_success "${package} installed successfully"
      else
        log_error "Failed to install ${package}"
        return 1
      fi
    else
      log_info "${package} is already installed"
    fi
  done
  log_success "All required packages installed"
}

main() {
  log_header "Installing Required Packages"

  log_step "Step 1: Install Homebrew"
  install_homebrew
  local exit_code=$?
  if [[ ${exit_code} -ne 0 ]]; then
    log_error "Failed to install Homebrew, aborting"
    exit 1
  fi

  log_step "Step 2: Install Required Packages"
  install_required_packages
  exit_code=$?
  if [[ ${exit_code} -ne 0 ]]; then
    log_error "Failed to install required packages, aborting"
    exit 1
  fi

  log_success "All installation steps completed successfully!"
}

main
