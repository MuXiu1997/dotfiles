#!/usr/bin/env bash

set -euo pipefail

# Source the shell library
source {{ joinPath .chezmoi.sourceDir ".chezmoiscripts" ".lib.sh" | quote }}

install_homebrew() {
  if ! type brew &>/dev/null; then
    if bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"; then
      log_success "Homebrew installation completed"
    else
      log_error "Failed to install Homebrew"
      return 1
    fi
  else
    log_info "Homebrew is already installed"
  fi
}

install_required_packages() {
  local packages=("git" "age" "chezmoi" "uv" "deno")

  for package in "${packages[@]}"; do
    if ! {{ .homebrewExec }} list --versions "$package" &>/dev/null; then
      log_progress "Installing $package..."
      if {{ .homebrewExec }} install "$package"; then
        log_success "$package installed successfully"
      else
        log_error "Failed to install $package"
        return 1
      fi
    else
      log_info "$package is already installed"
    fi
  done
  log_success "All required packages installed"
}

main() {
  log_header "Installing Required Packages"

  log_step "Step 1: Install Homebrew"
  if ! install_homebrew; then
    log_error "Failed to install Homebrew, aborting"
    exit 1
  fi

  log_step "Step 2: Install Required Packages"
  if ! install_required_packages; then
    log_error "Failed to install required packages, aborting"
    exit 1
  fi

  log_success "All installation steps completed successfully!"
}

main
