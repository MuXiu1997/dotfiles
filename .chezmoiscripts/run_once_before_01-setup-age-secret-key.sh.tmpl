#!/usr/bin/env bash

set -euo pipefail

# Source the shell library
source {{ joinPath .chezmoi.sourceDir ".chezmoiscripts" ".lib.sh" | quote }}

export PATH="{{ .homebrewBin }}:$PATH"

main() {
  log_header "Setting up Age Secret Key"

  {{ $ageKey := joinPath .XDG_DATA_HOME "age_secret_key" -}}
  local age_key={{ $ageKey | quote }}
  local encrypted_key={{ joinPath .chezmoi.sourceDir ".age_secret_key.age" | quote }}

  if [ ! -f "$age_key" ]; then
    log_step "Setting up age secret key..."

    if [ ! -f "$encrypted_key" ]; then
      log_error "Encrypted key file not found: $encrypted_key"
      exit 1
    fi

    log_progress "Decrypting and installing key to $age_key"
    if age --decrypt --output "$age_key" "$encrypted_key"; then
      log_success "Age secret key installed successfully"

      log_progress "Setting secure permissions (600)"
      if chmod 600 "$age_key"; then
        log_success "Permissions set successfully"
      else
        log_error "Failed to set permissions on $age_key"
        exit 1
      fi
    else
      log_error "Failed to setup age secret key"
      exit 1
    fi
  else
    log_info "Age secret key already exists at $age_key"
  fi

  log_success "Age secret key setup completed"
}

main
