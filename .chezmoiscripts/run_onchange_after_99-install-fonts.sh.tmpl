#!/usr/bin/env bash
# {{ if ne .chezmoi.os "darwin" }}{{ abortEmpty }}{{ end }}

set -euo pipefail

# {{ template "shellLib" . }}

# {{ $fontCacheDir := joinPath .chezmoi.homeDir ".cache/chezmoi-external-fonts" }}
: <<'CHZ_TEMPLATE'
# Font Cache Content Hashes:
{{- range (list "ttf" "otf" "ttc" "TTF") }}
{{- $ext := . }}
{{- range (glob (joinPath $fontCacheDir (printf "**/*.%s" $ext))) }}
# {{ . }}: {{ include . | sha256sum }}
{{- end }}
{{- end }}
CHZ_TEMPLATE

main() {
  log_header "Installing Fonts from External Cache"

  # shellcheck disable=SC2154
  local font_src="{{ $fontCacheDir }}"
  local font_dest="/Library/Fonts"

  log_progress "Updating fonts in ${font_dest}..."

  # 1. JetBrains Mono (Variable)
  log_progress "Installing JetBrains Mono (Variable)..."
  find -E "${font_src}/JetBrainsMono" -type f -regex '.*/fonts/variable/.*\.ttf' -exec sudo cp -f {} "${font_dest}/" \;

  # 2. Source Han Sans (TTC)
  log_progress "Installing Source Han Sans..."
  find "${font_src}/SourceHanSans" -type f -name "*.ttc" -exec sudo cp -f {} "${font_dest}/" \;

  # 3. Nerd Fonts JetBrains Mono
  log_progress "Installing Nerd Fonts JetBrains Mono..."
  find "${font_src}/NerdFontsJetBrainsMono" -type f -name "*.ttf" -exec sudo cp -f {} "${font_dest}/" \;

  # 4. Maple Mono MuXiu1997
  log_progress "Installing Maple Mono MuXiu1997..."
  find "${font_src}/MapleMonoMuXiu1997" -type f -name "*.ttf" -exec sudo cp -f {} "${font_dest}/" \;

  # 5. External Fonts
  log_progress "Installing External Fonts..."
  find -E "${font_src}/ExternalFonts" -type f -regex '.*\.(otf|ttf|TTF)' -exec sudo cp -f {} "${font_dest}/" \;

  log_success "Font installation completed successfully!"

  # Update font cache
  log_progress "Updating font cache..."
  fc-cache -f >/dev/null 2>&1 || true
}

main
