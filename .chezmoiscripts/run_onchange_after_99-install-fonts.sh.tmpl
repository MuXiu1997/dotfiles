#!/usr/bin/env bash
# {{ if ne .chezmoi.os "darwin" }}{{ abortEmpty }}{{ end }}

set -euo pipefail

# {{ template "shellLib" . }}

install_font() {
  local font_name="$1"
  local url="$2"
  local file_regex="$3"
  local temp_dir
  temp_dir=$(mktemp -d)

  log_progress "Installing ${font_name}..."

  # Download the font archive
  if ! curl -L "${url}" -o "${temp_dir}/font.zip" --silent --show-error; then
    log_error "Failed to download ${font_name} from ${url}"
    rm -rf "${temp_dir}"
    return 1
  fi

  # Unzip the font archive
  if ! unzip -q "${temp_dir}/font.zip" -d "${temp_dir}"; then
    log_error "Failed to extract ${font_name} archive"
    rm -rf "${temp_dir}"
    return 1
  fi

  # Find matching font files using extended regex
  local font_files
  font_files=$(find -E "${temp_dir}" -type f -regex "${file_regex}")

  if [[ -z "${font_files}" ]]; then
    log_error "No font files matching '${file_regex}' found in ${font_name} archive"
    rm -rf "${temp_dir}"
    return 1
  fi

  local copy_failed=false
  while IFS= read -r font_file; do
    local filename
    filename=$(basename "${font_file}")
    if ! sudo cp "${font_file}" "/Library/Fonts/${filename}"; then
      log_error "Failed to copy ${filename} to /Library/Fonts"
      copy_failed=true
    fi
  done <<<"${font_files}"

  # Clean up
  rm -rf "${temp_dir}"

  if [[ "${copy_failed}" == "true" ]]; then
    log_error "Failed to install some fonts from ${font_name}"
    return 1
  fi

  log_success "${font_name} installed successfully"
  return 0
}

install_all_fonts() {
  local failed_fonts=()

  # JetBrains Mono (variable fonts)
  local jb_mono_url='{{ gitHubLatestReleaseAssetURL "JetBrains/JetBrainsMono" "JetBrainsMono-*.zip" }}'
  install_font "JetBrains Mono" "${jb_mono_url}" '.*/fonts/variable/.*\.ttf'
  local exit_code=$?
  if [[ ${exit_code} -ne 0 ]]; then
    failed_fonts+=("JetBrains Mono")
  fi

  # Source Han Sans
  local shs_url='{{ gitHubLatestReleaseAssetURL "adobe-fonts/source-han-sans" "*SourceHanSans.ttc.zip" }}'
  install_font "Source Han Sans" "${shs_url}" '.*\.ttc'
  exit_code=$?
  if [[ ${exit_code} -ne 0 ]]; then
    failed_fonts+=("Source Han Sans")
  fi

  # Nerd Fonts - JetBrains Mono
  local nf_jb_mono_url='{{ gitHubLatestReleaseAssetURL "ryanoasis/nerd-fonts" "JetBrainsMono.zip" }}'
  install_font "Nerd Fonts JetBrains Mono" "${nf_jb_mono_url}" '.*\.ttf'
  exit_code=$?
  if [[ ${exit_code} -ne 0 ]]; then
    failed_fonts+=("Nerd Fonts JetBrains Mono")
  fi

  # Maple Mono MuXiu1997
  local maple_mono_url='{{ gitHubLatestReleaseAssetURL "MuXiu1997/maple-font-custom" "*-NF-CN-*.zip" }}'
  install_font "Maple Mono MuXiu1997" "${maple_mono_url}" '.*\.ttf'
  exit_code=$?
  if [[ ${exit_code} -ne 0 ]]; then
    failed_fonts+=("Maple Mono MuXiu1997")
  fi

  # Custom Fonts from fonts branch
  local custom_fonts_url="https://github.com/MuXiu1997/dotfiles/archive/fonts.zip"
  install_font "Custom Fonts" "${custom_fonts_url}" '.*\.(otf|ttf|TTF)'
  exit_code=$?
  if [[ ${exit_code} -ne 0 ]]; then
    failed_fonts+=("Custom Fonts")
  fi

  # Report results
  if [[ "${#failed_fonts[@]}" -eq 0 ]]; then
    log_success "All fonts installed successfully"
    return 0
  else
    log_error "Failed to install ${#failed_fonts[@]} font(s): ${failed_fonts[*]}"
    return 1
  fi
}

update_font_cache() {
  log_progress "Updating font cache..."
  fc-cache -f >/dev/null 2>&1
  local exit_code=$?
  if [[ ${exit_code} -eq 0 ]]; then
    log_success "Font cache updated successfully"
    return 0
  else
    log_warn "Failed to update font cache (fc-cache not available or failed)"
    return 0 # Non-critical failure
  fi
}

main() {
  log_header "Installing Fonts"

  install_all_fonts
  local exit_code=$?
  if [[ ${exit_code} -ne 0 ]]; then
    log_error "Font installation failed, aborting"
    exit 1
  fi

  update_font_cache

  log_success "Font installation completed successfully!"
}

main
