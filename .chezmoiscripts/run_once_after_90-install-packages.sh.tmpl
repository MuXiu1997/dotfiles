#!/usr/bin/env bash

set -euo pipefail

# {{ template "shellLib" . }}

install_packages() {
  local packages=()
  # {{ range (includeTemplate "homebrewPackages" . | fromYaml) }}
  packages+=('{{ . }}')
  # {{ end }}

  if [[ "${#packages[@]}" -gt 0 ]]; then
    local package_count="${#packages[@]}"
    log_progress "Installing ${package_count} packages..."

    local install_script='{{ joinPath .chezmoi.sourceDir "dot_local/bin/executable_install-packages" }}'

    if deno run -A --quiet --ext ts "${install_script}" "${packages[@]}"; then
      log_success "All ${package_count} packages processed successfully"
      return 0
    else
      log_error "Package installation failed"
      return 1
    fi
  else
    log_info "No packages to install"
    return 0
  fi
}

main() {
  log_header "Installing Homebrew Packages"

  install_packages
  local exit_code=$?
  if [[ ${exit_code} -ne 0 ]]; then
    log_error "Package installation failed, aborting"
    exit 1
  fi

  log_success "Package installation completed successfully!"
}

main
